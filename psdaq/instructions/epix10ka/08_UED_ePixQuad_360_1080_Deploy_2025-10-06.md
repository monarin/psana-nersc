# UED Deploy Note — ePixQuad 360 Hz & 1080 Hz

**Date:** 2025-10-06  
**LCLS2 tag:** `deploy-ued-epix1k-20251006`  
**Scope:** Add selectable detType for ePixQuad ~1 kfps path, ship config + utils for 1 kfps, validate 1080 Hz (and 360 Hz) operation, record submodule versions and test runs.
**Versions:** epix-quad-1kfps v2.1.3, lcls2-pgp-pcie-app v3.15.0

---

## Summary

- **New detType:** `epixquad1kfps` registered to the existing `EpixQuad` C++ implementation so it can be selected via `-D epixquad1kfps`.
- **New config module:** `psdaq/psdaq/configdb/epixquad1kfps_config.py`  
  Exports `epixquad1kfps_*` wrappers (forward to existing `epixquad_*` functions) and **opens no DMA VCs** during config (`enVcMask=0x0`) to avoid DRP/Python double-open.
- **New utils:** `psdaq/psdaq/utils/enable_epix_quad1kfps.py`  
  Sets up Rogue/python library paths for the `epix-quad-1kfps` submodule layout.
- **Validated 1080 Hz on ASC:** ascdaq123 runs **334 (FL)**, **335 (FM)**, **336 (FH)**.  
- **Validated 360 Hz on UED:** uedc00104 runs **246 (FL)**, **247 (FM)**, **248 (FH)**; FL pixel bitmap shows expected value **8**.
- **Incompatible pcie firmware:** To switch between the 360 and the 1080, the pcie firmware needs to be reflashed. See below for instructions.
- **start_ns at UED (119MHz):** The value has been set to 44000 (similar to the 360). Here's the detail calculation of the DAQ triggerDelay:
  ```
  /cds/home/opr/uedopr/2025/10/15_18:00:28_drp-ued-cmp003:epixquad1kfps_0.log:partitionDelay 11  rawStart 44000 clk_period 8.403361344537815 msg_period 238 triggerDelay 2618
  ```

---

## Changes (code)

- `psdaq/drp/PGPDetectorApp.cc`  
  ```diff
  f.register_type<EpixQuad> ("epixquad");
  +f.register_type<EpixQuad> ("epixquad1kfps");
  ```
- `psdaq/psdaq/configdb/epixquad1kfps_config.py`  
  - Wraps `epixquad1kfps_*` → `epixquad_*` implementations.  
  - Uses `ePixQuad.Top(..., enVcMask=0x0)` during config (no DMA claim from Python).
- `psdaq/psdaq/utils/enable_epix_quad1kfps.py`  
  - Adds firmware/python paths for `epix-quad-1kfps` and helpers.

---

## Submodules (runtime snapshot)

**Environment path:**  
`/cds/sw/ds/ana/conda2/rel/lcls2_submodules_10022025`

- **epix-quad**: **v1.3.1**  
- **epix-quad-1kfps**: **v2.1.3**

> Tip: capture `git submodule status` in ops notes if you rebuild this stack later.

---

## Pcie firmware 
The pairing firmware for the Pcie for epix-quad-1kfps v2.1.3 is v3.15.0. The MCS files can be located here:
```
cd /cds/home/m/monarin/firmware/kcu1500/3.15.0-drp-ued-cmp003/epixquad-1080hz
monarin@psbuild-rocky9-01 epixquad-1080hz ls -l
total 80272
-rw-r--r-- 1 monarin xu 41097940 Oct  6 09:55 Lcls2XilinxKcu1500Pgp4_10Gbps-0x03150000-20250828190444-ruckman-3448db2_primary.mcs
-rw-r--r-- 1 monarin xu 41097940 Oct  6 09:55 Lcls2XilinxKcu1500Pgp4_10Gbps-0x03150000-20250828190444-ruckman-3448db2_secondary.mcs
```
Note that the correponding Pcie firmware for epix-quad 360 is the same version but different MCS files
```
monarin@psbuild-rocky9-01 epixquad-360hz ls -l
total 81776
-rw-r--r-- 1 monarin xu 41868624 Oct  6 09:51 Lcls2XilinxKcu1500Pgp4_6Gbps-0x03150000-20250828174255-ruckman-3448db2_primary.mcs
-rw-r--r-- 1 monarin xu 41868624 Oct  6 09:51 Lcls2XilinxKcu1500Pgp4_6Gbps-0x03150000-20250828174255-ruckman-3448db2_secondary.mcs
```
To repgrogram the pcie firmware:
```
cd $SUBMODULEDIR/lcls2-pgp-pcie-app/software
python scripts/updatePcieFpga.py --path <PATH_TO_IMAGE_DIR>
```
Note that Matt suggested using --rescan (if the version of software supports it) to not having to power cycle the node after.

---

## Validation data

### ASC (1080 Hz)
- **Runs:** ascdaq123 — **334 (FL)**, **335 (FM)**, **336 (FH)**  
- **Notes:** Correct gain selection in raw; expected mean/noise separation across FL/FM/FH.

### UED (360 Hz)
- **Runs:** uedc00104 — **246 (FL)**, **247 (FM)**, **248 (FH)**  
- **Notes:** In FL, pixel bitmap shows **8** as expected.

---

## Operational notes / gotchas

- **Manual register override (1080 Hz):**  
  Default `AsicRoClkT` is `0x2`. Until firmware/configdb default is corrected, set:
  ```python
  cbase.AcqCore.AsicRoClkT.set(int(0xaaaa0003))
  ```
  (write-protect mask applied)

- **Avoid DMA double-open:**  
  When configuring via embedded Python, **do not** open data VCs from Python while DRP is running. We set `enVcMask=0x0` in `ePixQuad.Top(...)`.

- **Typical DRP invocation (example):**
  ```bash
  drp -P asc -C drp-det-cmp001 -M /cds/group/psdm/psdatmgr/etc/config/prom/asc       -o /u2/pcds/pds -k ep_provider=sockets,ep_domain=enp1s0f0       -d /dev/datadev_0 -k batching=yes -l 0x1       -D epixquad1kfps -p 2 -u epix10ka_0 -W 6 -vvv
  ```

---

## Deployment tag

- **Tag name:** `deploy-ued-epix1k-20251006`  
- **Branch:** `master` (pushed)  
- **Purpose:** Bookmark for UED Monday deploy; easy rollback/reference.

Create/push (for reference):
```bash
git push origin master
git tag -a deploy-ued-epix1k-20251006 -m "UED deploy: add detType 'epixquad1kfps'; validate 360/1080. Submodules: epix-quad v1.3.1; epix-quad-1kfps v2.1.3. Runs: ascdaq123 334–336; uedc00104 246–248. Note: AsicRoClkT=0xaaaa0003 for 1080."
git push origin deploy-ued-epix1k-20251006
```

---

## Troubleshooting appendix

- **`AxiStreamDma: Failed to open ... /dev/datadev_0 dest 0x1`**  
  Another process (DRP) owns the VC. Ensure config Python uses `enVcMask=0x0` and kill stray processes (`fuser -v /dev/datadev_0`).

- **`**** python error` then abort**  
  Usually due to missing symbol names. Ensure `epixquad1kfps_*` wrappers exist in `epixquad1kfps_config.py`.

---

## Contacts

- DAQ/psdaq: Chris O., Matt W., Riccardo  
- Detector/firmware: Phil H., Julian, team  
- Deployment owner: **Mona** (Monarin)
